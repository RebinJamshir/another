<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Fincorp Mobile Barcode Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
            height: 100vh;
            padding: 10px;
        }
        .header {
            text-align: center;
            margin-bottom: 15px;
        }
        .header h1 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 12px;
            color: #aaa;
        }
        #video-container {
            position: relative;
            flex: 1;
            background: #222;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 15px;
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #4CAF50;
        }
        .corner-top-left {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }
        .corner-top-right {
            top: 20px;
            right: 20px;
            border-left: none;
            border-bottom: none;
        }
        .corner-bottom-left {
            bottom: 20px;
            left: 20px;
            border-right: none;
            border-top: none;
        }
        .corner-bottom-right {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }
        .last-scan {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .last-scan-label {
            color: #aaa;
            font-size: 11px;
            margin-bottom: 4px;
        }
        .last-scan-value {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            color: #4CAF50;
            font-weight: 600;
        }
        .buttons {
            display: flex;
            gap: 8px;
        }
        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-send {
            background: #4CAF50;
            color: white;
        }
        .btn-send:hover {
            background: #45a049;
        }
        .btn-close {
            background: #7F55B1;
            color: white;
        }
        .btn-close:hover {
            background: #6B4799;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .status {
            text-align: center;
            font-size: 12px;
            color: #aaa;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            margin-bottom: 8px;
        }
        .status.success {
            background: #1a4d1a;
            color: #4CAF50;
        }
        .status.error {
            background: #4d1a1a;
            color: #f44336;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“± Fincorp Scanner</h1>
        <p>Point camera at barcode</p>
    </div>

    <div id="status" class="status">Starting camera...</div>

    <div id="video-container">
        <video id="video" autoplay playsinline></video>
        <div class="corner corner-top-left"></div>
        <div class="corner corner-top-right"></div>
        <div class="corner corner-bottom-left"></div>
        <div class="corner corner-bottom-right"></div>
    </div>

    <div class="last-scan" style="display:none;" id="lastScanDiv">
        <div class="last-scan-label">Last Scan:</div>
        <div class="last-scan-value" id="lastScan">-</div>
    </div>

    <div class="buttons">
        <button class="btn btn-send" id="sendBtn" onclick="sendBarcode()" disabled>Send</button>
        <button class="btn btn-close" onclick="window.close()">Close</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/@zxing/library@latest"></script>
    <script>
        let lastScannedBarcode = '';
        let codeReader = null;
        let desktopWindow = null;

        // Get desktop window reference from URL param
        function initDesktopLink() {
            try {
                if (window.opener) {
                    desktopWindow = window.opener;
                    console.log('Connected to desktop window');
                }
            } catch (e) {
                console.warn('Cannot access desktop window:', e);
            }
        }

        // Start barcode scanning with ZXing
        async function startScanning() {
            const video = document.getElementById('video');
            const status = document.getElementById('status');

            try {
                codeReader = new ZXing.BrowserMultiFormatReader();
                status.textContent = 'Requesting camera access...';

                // Get camera stream
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
                });

                video.srcObject = stream;
                status.textContent = 'Ready - Point at barcode';
                status.className = 'status success';

                // Decode continuously
                const result = await codeReader.decodeFromVideoElement(video, (result, err) => {
                    if (result && result.text) {
                        handleBarcodeScanned(result.text);
                    }
                });
            } catch (err) {
                status.textContent = 'Error: ' + (err.message || 'Camera access denied');
                status.className = 'status error';
                console.error('Scanner error:', err);
                // Fallback: allow manual input
                showManualInputFallback();
            }
        }

        function handleBarcodeScanned(barcode) {
            lastScannedBarcode = barcode;
            const lastScanDiv = document.getElementById('lastScanDiv');
            const lastScan = document.getElementById('lastScan');
            const sendBtn = document.getElementById('sendBtn');
            const status = document.getElementById('status');

            lastScan.textContent = barcode;
            lastScanDiv.style.display = 'block';
            sendBtn.disabled = false;
            status.textContent = 'Scanned: ' + barcode;
            status.className = 'status success';
        }

        function sendBarcode() {
            if (!lastScannedBarcode) {
                alert('No barcode scanned');
                return;
            }

            try {
                if (desktopWindow && desktopWindow.receiveBarcodeFromMobile) {
                    desktopWindow.receiveBarcodeFromMobile(lastScannedBarcode);
                    const status = document.getElementById('status');
                    status.textContent = 'Sent to POS!';
                    status.className = 'status success';
                    setTimeout(() => {
                        status.textContent = 'Ready - Point at barcode';
                    }, 1500);
                } else {
                    alert('Cannot connect to POS. Make sure you opened this from the POS app.');
                }
            } catch (e) {
                alert('Error sending barcode: ' + e.message);
                console.error('Send error:', e);
            }
        }

        function showManualInputFallback() {
            const container = document.getElementById('video-container');
            container.innerHTML = `
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; text-align: center;">
                    <p style="margin-bottom: 20px; color: #aaa;">Camera access denied or unavailable.</p>
                    <p style="font-size: 12px; color: #999;">You can still enter barcodes manually:</p>
                    <input type="text" id="manualBarcode" placeholder="Enter barcode" style="padding: 10px; margin: 10px 0; width: 100%; max-width: 300px; border-radius: 4px; border: 1px solid #555; background: #222; color: #fff; font-size: 14px;">
                    <button onclick="useManualBarcode()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Use</button>
                </div>
            `;
        }

        function useManualBarcode() {
            const input = document.getElementById('manualBarcode');
            if (input && input.value.trim()) {
                handleBarcodeScanned(input.value.trim());
                input.value = '';
            }
        }

        // Initialize on load
        window.addEventListener('load', () => {
            initDesktopLink();
            startScanning();
        });

        // Cleanup on close
        window.addEventListener('beforeunload', () => {
            if (codeReader) {
                codeReader.reset();
            }
        });
    </script>
</body>
</html>
